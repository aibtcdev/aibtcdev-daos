<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Stacks Transaction Cost Analysis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
      }
      /* Updated to use brand orange color palette */
      .limit-highlight {
        background-color: #ff4f03;
        color: white;
      }
      .sort-highlight {
        background-color: #0533d1;
        color: white;
      }
    </style>
  </head>
  <body class="bg-gray-50 text-gray-800">
    <div class="container mx-auto p-4 md:p-8">
      <header class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900">
          Stacks Transaction Cost Analysis
        </h1>
        <p class="mt-2 text-lg text-gray-600">
          This report analyzes the provided cost data to determine the maximum
          number of transactions that can fit into a single block, highlighting
          the limiting factor for each transaction type.
        </p>
      </header>

      <!-- Legend for the cost dimensions -->
      <div
        class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 mb-8"
      >
        <h2 class="text-xl font-semibold mb-3 text-gray-800">
          Understanding the Metrics
        </h2>
        <div
          class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 text-sm"
        >
          <div class="p-3 bg-gray-100 rounded-lg">
            <h3 class="font-bold">Runtime</h3>
            <p class="text-gray-600">The computational effort required.</p>
          </div>
          <div class="p-3 bg-gray-100 rounded-lg">
            <h3 class="font-bold">Read Count</h3>
            <p class="text-gray-600">Number of database reads.</p>
          </div>
          <div class="p-3 bg-gray-100 rounded-lg">
            <h3 class="font-bold">Read Length</h3>
            <p class="text-gray-600">Total size (bytes) of data read.</p>
          </div>
          <div class="p-3 bg-gray-100 rounded-lg">
            <h3 class="font-bold">Write Count</h3>
            <p class="text-gray-600">Number of database writes.</p>
          </div>
          <div class="p-3 bg-gray-100 rounded-lg">
            <h3 class="font-bold">Write Length</h3>
            <p class="text-gray-600">Total size (bytes) of data written.</p>
          </div>
        </div>
        <p class="mt-4 text-sm text-gray-500">
          For each transaction, we calculate how many could fit in a block based
          on each of the five limits. The lowest number determines the actual
          maximum, and its corresponding metric is the
          <span class="font-semibold" style="color: #ff4f03"
            >limiting factor</span
          >.
        </p>
      </div>

      <!-- Key Insights Summary -->
      <div id="summary-container" class="mb-8">
        <!-- Summary will be generated here -->
      </div>

      <!-- Controls for sorting and filtering -->
      <div
        class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 mb-8 flex flex-col md:flex-row gap-4"
      >
        <div class="flex-1">
          <label
            for="sort-select"
            class="block text-sm font-medium text-gray-700 mb-1"
            >Sort by</label
          >
          <select
            id="sort-select"
            class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-orange-500 focus:border-orange-500"
          >
            <option value="max-txs-desc">Max Txs (High to Low)</option>
            <option value="max-txs-asc">Max Txs (Low to High)</option>
            <option value="runtime-desc">Runtime (High to Low)</option>
            <option value="read_count-desc">Read Count (High to Low)</option>
            <option value="read_length-desc">Read Length (High to Low)</option>
            <option value="write_count-desc">Write Count (High to Low)</option>
            <option value="write_length-desc">Write Length (High to Low)</option>
          </select>
        </div>
        <div class="flex-1">
          <label
            for="contract-filter-select"
            class="block text-sm font-medium text-gray-700 mb-1"
            >Filter by Contract</label
          >
          <select
            id="contract-filter-select"
            class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-orange-500 focus:border-orange-500"
          >
            <option value="all">All Contracts</option>
          </select>
        </div>
      </div>

      <!-- This div will be populated with transaction cost cards by the script -->
      <main id="report-container">
        <!-- Loading indicator -->
        <div
          id="loading"
          class="flex flex-col items-center justify-center p-12 bg-white rounded-xl shadow-sm border border-gray-200"
        >
          <svg
            class="animate-spin h-8 w-8 text-gray-500"
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
          >
            <circle
              class="opacity-25"
              cx="12"
              cy="12"
              r="10"
              stroke="currentColor"
              stroke-width="4"
            ></circle>
            <path
              class="opacity-75"
              fill="currentColor"
              d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
            ></path>
          </svg>
          <p class="mt-4 text-lg font-medium text-gray-600">
            Analyzing cost report...
          </p>
        </div>
      </main>
    </div>

    <script type="module">
      // Global store for our transaction data
      let allProcessedTxs = [];

      // Main function to orchestrate the analysis and rendering
      async function generateReport() {
        try {
          const response = await fetch("./costs-reports.json");
          if (!response.ok) {
            throw new Error(
              `Failed to fetch costs-reports.json: ${response.statusText}`
            );
          }
          const costsData = await response.json();

          if (!costsData || costsData.length === 0) {
            throw new Error("Fetched cost data is missing or empty.");
          }

          allProcessedTxs = processCostData(costsData);
          renderSummary(allProcessedTxs);
          populateContractFilter(allProcessedTxs);
          updateReportView(); // Initial render

          // Add event listeners for controls
          document
            .getElementById("sort-select")
            .addEventListener("change", updateReportView);
          document
            .getElementById("contract-filter-select")
            .addEventListener("change", updateReportView);
        } catch (error) {
          console.error("Failed to load or process cost report:", error);
          const container = document.getElementById("report-container");
          container.innerHTML = `<div class="col-span-full bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg" role="alert"><strong class="font-bold">Error:</strong><span class="block sm:inline"> ${error.message}. Please ensure the JSON file is present and the HTML is accessed via a local server.</span></div>`;
        }
      }

      /**
       * Processes raw cost data to find the highest costs and calculate bottleneck info.
       */
      function processCostData(data) {
        const transactionCosts = new Map();
        data.forEach((item) => {
          const key = `${item.contract_id}.${item.method}`;
          if (!transactionCosts.has(key)) {
            transactionCosts.set(key, {
              key,
              contract_id: item.contract_id,
              method: item.method,
              cost: {
                runtime: 0,
                read_count: 0,
                read_length: 0,
                write_count: 0,
                write_length: 0,
              },
              limit: item.cost_result.limit,
              example_test: item.test_name,
            });
          }
          const current = transactionCosts.get(key);
          const newCost = item.cost_result.total;
          Object.keys(current.cost).forEach(
            (k) => (current.cost[k] = Math.max(current.cost[k], newCost[k]))
          );
        });

        const meaningfulTransactions = Array.from(
          transactionCosts.values()
        ).filter((tx) => Object.values(tx.cost).some((v) => v > 0));

        // Calculate limiting factors for each transaction
        meaningfulTransactions.forEach((tx) => {
          const txsPerBlock = {
            runtime: calculateTxs(tx.limit.runtime, tx.cost.runtime),
            read_count: calculateTxs(tx.limit.read_count, tx.cost.read_count),
            read_length: calculateTxs(
              tx.limit.read_length,
              tx.cost.read_length
            ),
            write_count: calculateTxs(
              tx.limit.write_count,
              tx.cost.write_count
            ),
            write_length: calculateTxs(
              tx.limit.write_length,
              tx.cost.write_length
            ),
          };
          tx.limitingFactor = Object.keys(txsPerBlock).reduce((a, b) =>
            txsPerBlock[a] < txsPerBlock[b] ? a : b
          );
          tx.minTxs = txsPerBlock[tx.limitingFactor];
        });

        return meaningfulTransactions;
      }

      /**
       * Generates and renders a summary table of key insights.
       */
      function renderSummary(txs) {
        if (txs.length === 0) return;

        const container = document.getElementById("summary-container");

        // Find top 3 for each category
        const top3Bottlenecks = [...txs]
          .sort((a, b) => a.minTxs - b.minTxs)
          .slice(0, 3);
        const top3Runtime = [...txs]
          .sort((a, b) => b.cost.runtime - a.cost.runtime)
          .slice(0, 3);
        const top3ReadCount = [...txs]
          .sort((a, b) => b.cost.read_count - a.cost.read_count)
          .slice(0, 3);
        const top3ReadLength = [...txs]
          .sort((a, b) => b.cost.read_length - a.cost.read_length)
          .slice(0, 3);
        const top3WriteCount = [...txs]
          .sort((a, b) => b.cost.write_count - a.cost.write_count)
          .slice(0, 3);
        const top3WriteLength = [...txs]
          .sort((a, b) => b.cost.write_length - a.cost.write_length)
          .slice(0, 3);

        const createGroupedRows = (label, topTxs) => {
          if (topTxs.length === 0) return "";
          return topTxs
            .map((tx, index) => {
              const contractName =
                tx.contract_id.split(".")[1] || tx.contract_id;
              const labelCell =
                index === 0
                  ? `<td class="py-3 px-4 border-b border-gray-200 text-sm font-medium text-gray-800 align-top" rowspan="${topTxs.length}">${label}</td>`
                  : "";
              return `
                <tr>
                  ${labelCell}
                  <td class="py-3 px-4 border-b border-gray-200 text-sm text-gray-600 font-mono">${contractName}: ${tx.method}()</td>
                </tr>
              `;
            })
            .join("");
        };

        container.innerHTML = `
          <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">Key Insights (Top 3)</h2>
            <div class="overflow-x-auto">
              <table class="min-w-full bg-white">
                <tbody>
                  ${createGroupedRows("Overall Bottlenecks", top3Bottlenecks)}
                  ${createGroupedRows(
                    "Most Runtime-Intensive",
                    top3Runtime
                  )}
                  ${createGroupedRows("Highest Read Counts", top3ReadCount)}
                  ${createGroupedRows("Highest Read Lengths", top3ReadLength)}
                  ${createGroupedRows("Highest Write Counts", top3WriteCount)}
                  ${createGroupedRows("Highest Write Lengths", top3WriteLength)}
                </tbody>
              </table>
            </div>
          </div>
        `;
      }

      /**
       * Populates the contract filter dropdown with unique contract names.
       */
      function populateContractFilter(txs) {
        const filterSelect = document.getElementById("contract-filter-select");
        const contractNames = [
          ...new Set(txs.map((tx) => tx.contract_id)),
        ].sort();
        contractNames.forEach((name) => {
          const option = document.createElement("option");
          option.value = name;
          option.textContent = name.split(".")[1] || name;
          filterSelect.appendChild(option);
        });
      }

      /**
       * Applies current filters and sorting, then re-renders the report.
       */
      function updateReportView() {
        const container = document.getElementById("report-container");
        const selectedContract = document.getElementById(
          "contract-filter-select"
        ).value;
        const sortBy = document.getElementById("sort-select").value;

        // 1. Filter
        let filteredTxs = allProcessedTxs;
        if (selectedContract !== "all") {
          filteredTxs = allProcessedTxs.filter(
            (tx) => tx.contract_id === selectedContract
          );
        }

        // 2. Group by contract
        const groupedByContract = filteredTxs.reduce((acc, tx) => {
          (acc[tx.contract_id] = acc[tx.contract_id] || []).push(tx);
          return acc;
        }, {});

        // 3. Sort and Render
        container.innerHTML = ""; // Clear previous results
        if (Object.keys(groupedByContract).length === 0) {
          container.innerHTML = `<div class="text-center p-12 bg-white rounded-xl shadow-sm border border-gray-200"><p class="text-lg font-medium text-gray-600">No transactions match the current filter.</p></div>`;
          return;
        }

        const parts = sortBy.split("-");
        const sortDir = parts.pop();
        const sortKey = parts.join("-");

        for (const contractId in groupedByContract) {
          const contractSection = document.createElement("section");
          contractSection.className = "mb-12";

          const contractName = contractId.split(".")[1] || contractId;
          const contractTitle = document.createElement("h2");
          contractTitle.className =
            "text-2xl font-bold text-gray-800 mb-4 pb-2 border-b-2 border-gray-200";
          contractTitle.textContent = contractName;
          contractSection.appendChild(contractTitle);

          const cardContainer = document.createElement("div");
          cardContainer.className =
            "grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6";

          // Sort transactions within the group
          const transactions = groupedByContract[contractId];
          transactions.sort((a, b) => {
            let valA, valB;
            if (sortKey === "max-txs") {
              valA = a.minTxs;
              valB = b.minTxs;
            } else {
              valA = a.cost[sortKey];
              valB = b.cost[sortKey];
            }
            return sortDir === "asc" ? valA - valB : valB - valA;
          });

          transactions.forEach((tx) => {
            cardContainer.appendChild(createTransactionCard(tx, sortBy));
          });

          contractSection.appendChild(cardContainer);
          container.appendChild(contractSection);
        }
      }

      /**
       * Creates an HTML element for a single transaction's cost analysis.
       */
      function createTransactionCard(txData, sortBy) {
        const card = document.createElement("div");
        card.className =
          "bg-white p-6 rounded-xl shadow-sm hover:shadow-lg transition-shadow duration-300 border border-gray-200 flex flex-col";

        const { cost, limit, limitingFactor, minTxs } = txData;
        const txsPerBlock = {
          runtime: calculateTxs(limit.runtime, cost.runtime),
          read_count: calculateTxs(limit.read_count, cost.read_count),
          read_length: calculateTxs(limit.read_length, cost.read_length),
          write_count: calculateTxs(limit.write_count, cost.write_count),
          write_length: calculateTxs(limit.write_length, cost.write_length),
        };

        const contractName =
          txData.contract_id.split(".")[1] || txData.contract_id;
        const [sortKey] = sortBy.split("-");

        const createMetricRow = (name, costVal, txsVal, factorKey) => {
          const isLimit = factorKey === limitingFactor;
          const isSortedBy = factorKey === sortKey;

          // Use Math.floor and toLocaleString to format numbers without decimals.
          const formattedTxs = isFinite(txsVal)
            ? Math.floor(txsVal).toLocaleString()
            : "∞";

          let rowClass = "bg-gray-50";
          let txsClass = "text-gray-500";

          if (isSortedBy) {
            rowClass = "sort-highlight";
            txsClass = "text-white/80";
          } else if (isLimit) {
            rowClass = "limit-highlight font-bold";
            txsClass = "text-white/80";
          }

          return `
                    <div class="flex justify-between items-center py-2.5 px-3 rounded-md ${rowClass}">
                        <span class="text-sm font-medium capitalize">${name.replace(
                          "_",
                          " "
                        )}</span>
                        <div class="text-right">
                            <span class="text-sm font-semibold">${costVal.toLocaleString()}</span>
                            <span class="text-xs ${txsClass} ml-2">(${formattedTxs} txs/block)</span>
                        </div>
                    </div>
                `;
        };

        card.innerHTML = `
                <div class="flex-grow">
                    <h3 class="text-xl font-bold text-gray-900 break-words">${contractName}</h3>
                    <p class="text-md text-gray-500 mb-4 font-mono break-words">${
                      txData.method
                    }</p>
                    
                    <div class="mb-6 mt-2 pt-4 text-center">
                        <p class="text-sm text-gray-600">Max transactions per block:</p>
                        <p class="text-4xl font-bold" style="color: #FF4F03;">${
                          isFinite(minTxs)
                            ? Math.floor(minTxs).toLocaleString()
                            : "∞"
                        }</p>
                        <p class="text-sm font-semibold text-gray-800 mt-1">Limited by: <span class="capitalize font-bold" style="color: #FF4F03;">${limitingFactor.replace(
                          "_",
                          " "
                        )}</span></p>
                    </div>

                    <div class="space-y-2 border-t border-gray-200 pt-4">
                        ${createMetricRow(
                          "Runtime",
                          cost.runtime,
                          txsPerBlock.runtime,
                          "runtime"
                        )}
                        ${createMetricRow(
                          "Read Count",
                          cost.read_count,
                          txsPerBlock.read_count,
                          "read_count"
                        )}
                        ${createMetricRow(
                          "Read Length",
                          cost.read_length,
                          txsPerBlock.read_length,
                          "read_length"
                        )}
                        ${createMetricRow(
                          "Write Count",
                          cost.write_count,
                          txsPerBlock.write_count,
                          "write_count"
                        )}
                        ${createMetricRow(
                          "Write Length",
                          cost.write_length,
                          txsPerBlock.write_length,
                          "write_length"
                        )}
                    </div>
                </div>
            `;
        return card;
      }

      /**
       * Helper to calculate transactions per block, handling division by zero.
       */
      function calculateTxs(limit, cost) {
        return cost === 0 ? Infinity : limit / cost;
      }

      document.addEventListener("DOMContentLoaded", generateReport);
    </script>
  </body>
</html>
